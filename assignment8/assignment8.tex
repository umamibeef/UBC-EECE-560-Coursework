\documentclass[10pt, oneside, letterpaper]{article}
\usepackage[margin=1in]{geometry}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}
\usepackage{listings}
\lstset{
  backgroundcolor=\color{white}, % choose the background color
  basicstyle=\footnotesize\ttfamily, % size of fonts used for the code
  breaklines=true, % automatic line breaking only at whitespace
  frame=single, % add a frame
  captionpos=b, % sets the caption-position to bottom
  commentstyle=\color{mygreen}, % comment style
  escapeinside={\%*}{*)}, % if you want to add LaTeX within your code
  keywordstyle=\color{blue}, % keyword style
  stringstyle=\color{mymauve}, % string literal style
}
\usepackage{enumitem}
\usepackage{blindtext}
\usepackage{datetime2}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{arydshln} % dash line package for matrices
\usepackage{mathtools}
\usepackage{float}
\usepackage{pgf}

\title{Non-Linear Elements}
\author{Assignment 8}
\date{Due: 2021/04/19}

\pagestyle{fancy}
\setlength{\headheight}{23pt}
\setlength{\parskip}{1em}
\fancyhf{}
\chead{Assignment 8 \\ Non-Linear Elements}
\rhead{Michel Kakulphimp \\ Student \#63542880}
\lhead{EECE560 \\ UBC MEng}
\cfoot{\thepage}

\begin{document}
\maketitle
\thispagestyle{fancy}

\section{Introduction}

In this final assignment, we explore simulations of non-linear devices and the critical damping adjustment (CDA) technique to eliminate numerical oscillations that can occur with the trapezoidal discretization method. Numerical oscillations occur with this discretization technique when it encounters discontinuous inputs into its system, as we've seen throughout this class. CDA resolves this issue by dynamically changing the discretization method when a discontinuity is detected to a more stable one, and then reverting back to trapezoidal. To demonstrate its effectiveness, a non-linear inductance with saturating current is modeled and simulated in this assignment. The flux/current relationship of the non-linear inductance is approximated using a piecewise function which has discontinuities where its curves connect. A trapezoidal discretization with and without CDA will be performed to see how it improves the performance of the simulation.

\section{Setup}

Shown in Figure \ref{flux-plot} is the flux linkage to current relationship that is used in both the hand-implemented and PSCAD simulations. It emulates a continuous curve which describes how inductance changes value as the current through it increases. This is realistic, non-linear behaviour that occurs in inductors which have cores. The core material reaches a point where it can no longer linearly increase the amount of the magnetic flux generated by the current passing through the inductor's coil.

\begin{figure}[H]
  \begin{center}
    \input{flux_plot.pgf}
  \end{center}
  \caption{Piecewise flux linkage vs. current relationship for simulated non-linear, saturating inductance}
  \label{flux-plot}
\end{figure}

Due to this piecewise approximation, the flux linkage current relationship features a sharp change in slope at $0.1 A$. Trapezoidal discretization methods can struggle with discontinuities like this if the step size is not sufficiently small. The CDA method addresses this by changing the discretization method to backward Euler for two half steps. Trapezoidal discretization resumes after these two half steps.

The following sections will discuss both the hand-implemented nodal analysis simulation and the PSCAD implementation of the same circuit. Efforts were made to ensure that both PSCAD and hand-implemented simulations matched as closely as possible. This required careful alignment on things such as the main switch resistance as well as initial conditions to the circuit components.

\subsection{Hand-Implemented Solution}

As was implemented back in assignment 2, this assignment's hand-implemented simulation is derived using nodal analysis of the circuit. Shown in Figure \ref{assignment-schematic} is the assignment's circuit schematic, with the nodes used for nodal analysis. The switch is turned into a variable resistance $R_{sw}$ which the nodal analysis solution changes to a very small value when the switch closes to match PSCAD's switch implementation. The non-linear inductance $L$ is converted into its equivalent resistance $R_L$ as well as a current source $h_L$ representing its discretization history.

\begin{figure}[H]
  \centering
  \includegraphics[width=2.5in]{assignment-schematic.png}
  \caption{Schematic for circuit used in this assignment and its discretized equivalent}
  \label{assignment-schematic}
\end{figure}

Since the CDA technique requires that the discretization method fall back to backward Euler at discontinuities, the hand-implemented simulation implements both the trapezoidal and backward Euler discretization methods. The following steps demonstrate how each discretization was applied to the non-linear inductor's voltage and flux linkage relationship:

\begin{alignat}{2}
v(t) &= \frac{\lambda{}(t)}{dt} \\
\int_{t-\Delta{}t}^{t}v(t)dt &= \int_{t-\Delta{}t}^{t}d\lambda{}(t) \\
\text{approximated area of integration} &\simeq \lambda{}(t) - \lambda{}(t-\Delta{}t) \\
\end{alignat}

Trapezoidal:

\begin{alignat}{2}
\frac{v(t) + v(t-\Delta{}t)}{2} &= \lambda{}(t) - \lambda{}(t-\Delta{}t) \\
v(t) &= \frac{2}{\Delta{}t}\left[\lambda_{kn} + L_ni(t)\right] - v(t-\Delta{}t) - \frac{2}{\Delta{}t}\lambda{}(t - \Delta{}t) \\
\Aboxed{v(t) &= \frac{2L_n}{\Delta{}t}i(t) + \left[-v(t-\Delta{}t)-\frac{2}{\Delta{}t}\lambda{}(t - \Delta{}t) + \frac{2}{\Delta{}t}\lambda_{kn}\right]}
\end{alignat}

Backward Euler:

\begin{alignat}{2}
v(t)\Delta{}t &= \lambda{}(t) - \lambda{}(t-\Delta{}t) \\
v(t) &= \frac{1}{\Delta{}t}\left[\lambda_{kn} + L_ni(t)\right] - \frac{1}{\Delta{}t}\lambda{}(t - \Delta{}t) \\
\Aboxed{v(t) &= \frac{L_n}{\Delta{}t}i(t) + \left[-\frac{1}{\Delta{}t}\lambda{}(t - \Delta{}t) + \frac{1}{\Delta{}t}\lambda_{kn}\right]}
\end{alignat}

In both derivations, the flux linkage knee value $\lambda_{kn}$ and inductance $L_n$ are obtained from the flux linkage current plot shown in Figure \ref{flux-plot}. The simulation detects which region the inductor is currently in and will choose the values for each accordingly.

Using the derived equations above, the equivalent resistance $R_L$ and voltage source $eh_L$ can be obtained to represent the equivalent discretized circuit. Source transformation is used to change the equivalent voltage source to a current source. The following equations represent the equivalent resistances and history sources (using the node naming convention shown in Figure \ref{assignment-schematic}:

\begin{alignat}{2}
R_{L_{trap}} &= \frac{2L_n}{\Delta{}t} \\
R_{L_{euler}} &= \frac{L_n}{\Delta{}t} \\
eh_{L_{trap}}(t) &= -v_3(t) - \frac{2}{\Delta{}t}\lambda(t) + \frac{2}{\Delta{}t}\lambda_{kn}\\
eh_{L_{euler}}(t) &= -\frac{1}{\Delta{}t}\lambda(t) + \frac{1}{\Delta{}t}\lambda_{kn}\\
h_{L_{trap}}(t) &= \frac{eh_{L_{trap}}(t)}{R_{L_{trap}}}\\
h_{L_{euler}}(t) &= \frac{eh_{L_{euler}}(t)}{R_{L_{euler}}}
\end{alignat}

Once the current source histories are determined, the branch current, which is required for calculating the next nodal voltage values, can be calculated using the following relationship (where the appropriate discretization resistance and current source history is substituted):

\begin{alignat}{2}
i_{L}(t) &= v_{3}(t)/R_{L} - h_{L}(t)
\end{alignat}

For this exercise, the convention used for currents leaving the node marks them as positive and currents entering the node marks them as negative. Therefore the resulting branch currents are the nodal voltage divided by the branch resistance, minus the discretized component current sources for all branch currents in this circuit.

Finally, we can now calculate the nodal voltage equations using some clever matrix manipulation taught in class. This technique subdivides the usual nodal analysis conductance matrix into four sections, with nodes connected to known voltage sources occupying the outside matrices $\mathbf{G_{AB}}$, $\mathbf{G_{BA}}$, and $\mathbf{G_{BB}}$. This allows us to perform the following operation to obtain our nodal voltage equation vector:

\begin{alignat}{2}
\left[\mathbf{V_A(t)}\right] &= \left[\mathbf{G_{AA}}\right]^{-1}\left[\mathbf{h_A(t)}\right] - \left[\mathbf{G_{AA}}\right]^{-1}\left[\mathbf{G_{AA}}\right]\left[\mathbf{V_B(t)}\right]
\end{alignat}

For this implementation, the main switch closing and opening has the effect of changing the resistance of $R_{sw}$. Shown below are both conductance and history matrices used for this circuit's solution:

\begin{alignat}{2}
  \left[
  \mathbf{G}\right] &= \left[
      \begin{array}{c;{2pt/2pt}c}
        \mathbf{G_{AA}} & \mathbf{G_{AB}} \\ \hdashline[2pt/2pt]
        \mathbf{G_{BA}} & \mathbf{G_{BB}} 
      \end{array}
    \right] = \left[
      \begin{array}{cc;{2pt/2pt}c}
        \frac{1}{R_{sw}}    & -\frac{1}{R_{sw}}                 & 0                             \\ [6pt]
        -\frac{1}{R_{sw}}   & \frac{1}{R_{sw}} + \frac{1}{R}    & -\frac{1}{R}                  \\ [6pt] \hdashline[2pt/2pt]
        0                   & -\frac{1}{R}                      & \frac{1}{R} + \frac{1}{R_L}
      \end{array}
  \right]
\end{alignat}

\begin{alignat}{2}
    \left[
        \mathbf{H}
    \right] &= \left[
        \begin{array}{c}
            \mathbf{H_{A}} \\
            \hdashline[2pt/2pt] \mathbf{H_{B}}
        \end{array}\right] = \left[
        \begin{array}{c}
            0 \\
            h_{L}(t) \\
            \hdashline[2pt/2pt] 0 \end{array}\right]
\end{alignat}

The resulting nodal voltage equations were generated using MATLAB, whose source can be viewed in Listing \ref{code-listing-matlab}. The resulting equations were then ported to the final Python script which can be viewed in Listing \ref{code-listing-python}.

CDA is implemented in the hand-implemented solution by switching between the trapezoidal and backward Euler next voltage equations at the appropriate moment. A function named \texttt{get\_flux(current\_input)} was created to facilitate this. Current is passed into the \texttt{current\_input} parameter, and the function returns a tuple with the associated flux linkage value, flux linkage knee value, and inductance for the region. This allows for each iteration of the nodal analysis solution to use an up-to-date value as needed (based on the previous iteration's current). When a change of region is detected (by keeping track of the inductance from iteration to iteration), the backward Euler discretization equations are used for two half $\Delta{}t$ steps. After these two steps, the trapezoidal discretization equations are used once again.

\subsection{PSCAD Simulation}

The schematic diagram for the PSCAD solution can be found in Figure \ref{pscad-schematic}. Its main component is the variable inductance component, which is able to accept as an input an inductance value. By changing the inductance value with respect to the current going through the inductor, a non-linear saturating inductance can be emulated for the simulation.

\begin{figure}[H]
  \centering
  \includegraphics[width=4in]{pscad-schematic.png}
  \caption{Schematic for PSCAD implementation of the assignment circuit}
  \label{pscad-schematic}
\end{figure}

To implement the flux linkage current relationship, PSCAD's X-Y transfer function component is used to relate the current input to an inductance output. Conveniently, one can derive the inductance from the flux linkage current relationship as the inductance is simply the slope of the curve. Since we only have two linear piecewise components, this translates to two inductances: from 0 to 0.1, 0.02 Henries and from 0.1 onwards, 4.444e-4 Henries. Using this relationship, the inductance will track the current passing through the inductor as outlined by the flux linkage current plot.

In order to set the initial voltage on the inductor to be 10V, a connection is made from the 10V source to a breaker and then to the inductor. The breaker is set to open at t = 0s, which tells PSCAD that only at t = 0s does the inductor have 10V applied to it, giving it an initial value of 10V. The main switch is also used in a similar way, except that at t = 0s it is set to close instead of open.

As with the previous assignments using PSCAD, the required values are tapped off of their variable names and plotted directly on a single plot within the schematic. Right-clicking the plot allows one to export the data to the clipboard, which is in the form of comma separated values. For this assignment, this data was pasted into a dedicated \texttt{.csv} file which can be found in Listings \ref{data-listing-pscad-0p0001} and \ref{data-listing-pscad-0p0003}.

\subsection{Plot Generation}

The plots were all generated using the matplotlib python library. The python script listed in Listing \ref{code-listing-python} is responsible for generating all of the plots in this assignment. In order to get a good understanding of how CDA affected the results, the python script plots the following curves:

\begin{itemize}
    \item Continuous solution (ideal inductance)
    \item Continuous solution (non-linear inductance)
    \item Trapezoidal discretized solution (ideal inductance)
    \item Trapezoidal discretized solution (non-linear inductance)
    \item Trapezoidal discretized solution + CDA (non-linear inductance)
\end{itemize}

The continuous solutions were based on the ones from the first assignment. The non-linear inductance version of the continuous solution uses the flux linkage current relationship to dynamically change the inductor value during the simulation. The trapezoidal solution for the ideal inductance also uses the same implementation from the first assignment. For this assignment, however, the trapezoidal solutions differ from the first assignment as they implement nodal analysis. For the nodal analysis trapezoidal solutions, both model a non-linear inductance. The analysis is done twice, before and after applying CDA; this is to observe the effects the CDA has on the solution generated by the simulation.

\section{Results}

The following section contains the plots generated for this assignment. Two values of $\Delta{}t$ were chosen for plotting because $\Delta{}t = 0.0001s$ did not show much numerical instability. By increasing the time step to $\Delta{}t = 0.0003s$, the numerical instability becomes much more noticeable, and therefore the CDA improvement becomes much clearer. The plots are also zoomed in in order to appreciate the detail that occurs when the discontinuity is encountered in the flux linkage current function.

\begin{figure}[H]
  \begin{center}
    \input{compare_plots_0p0001.pgf}
  \end{center}
  \caption{Current and voltage simulation results for $\Delta{}t = 100\mu{}s$}
  \label{compare-plots-100us}
\end{figure}
\begin{figure}[H]
  \begin{center}
    \input{compare_plots_zoom_0p0001.pgf}
  \end{center}
  \caption{Zoomed in current and voltage simulation results for $\Delta{}t = 100\mu{}s$}
  \label{compare-plots-zoom-100us}
\end{figure}

\begin{figure}[H]
  \begin{center}
    \input{compare_plots_0p0003.pgf}
  \end{center}
  \caption{Current and voltage simulation results for $\Delta{}t = 300\mu{}s$}
  \label{compare-plots-300us}
\end{figure}
\begin{figure}[H]
  \begin{center}
    \input{compare_plots_zoom_0p0003.pgf}
  \end{center}
  \caption{Zoomed in current and voltage simulation results for $\Delta{}t = 300\mu{}s$}
  \label{compare-plots-zoom-300us}
\end{figure}

\newpage
\section{Discussion}

\begin{itemize}
    \item When comparing to PSCAD, we see that the trapezoidal solution with CDA compares favorably. Both show numerical stability at the discontinuity which means that PSCAD must also be implementing something similar to prevent numerical oscillations from occurring.
    \item The continuous solution of the non-linear inductance simulation changes much more quickly than the discretized solution, due to it seeing current changes immediately. The step size in the discretized solutions also means that region checking can only occur in the steps themselves and not in between, so the delay in inductance change compared to the continuous solution makes sense. In all non-linear inductance simulation plots, we observe that they eventually stabilize to the same values.
    \item When comparing the results to assignment 1, we see that before we hit 0.1A (where the flux linkage region changes), the plot is followed exactly. If assignment 1 had encountered similar discontinuities, it would have exhibited numerical stability just like this assignment.
    \item A saturating inductance will render an inductance useless after the saturating current has been reached. When choosing an inductor, it would be prudent to choose one whose saturating current threshold is well above the expected current operating threshold of the inductor in circuit. This would pose a problem in switch-mode power supplies which use inductors as energy storage device. If a load were to pull higher than expected current from the regulator's output, the reduction in inductance would cause it to become more resistive and likely generate wasted power in heat. This could damage the circuit due to the heat being generated.
    \item In order to generalize the implementation of CDA in a solver program, one could detect numerical instabilities by detecting if the solution's slope is oscillating between positive and negative slopes. The solver could then walk back the solution, apply backward Euler to resolve the numerical instability for some time, and then switch back to trapezoidal. Perhaps this could also be applied to a "live" input by buffering the input and applying both discretization methods simultaneously, and switching to backward Euler when the numerical instability is detected.
    \item Not a comment on this assignment, but in general for this class. I've learned a lot in doing these assignments and wanted to thank you for teaching such an interesting class. This will help me professionally in more ways than one.
\end{itemize}

\newpage
\section{Code Listings and Data}

\subsection{Python Code Listing}
\label{code-listing-python}
The following is the code written in Python to generate the solutions and plots used in this report.
\lstinputlisting[language=Python]{assignment8.py}

\subsection{PSCAD CSV File ($\Delta{}t = 0.0001s$)}
\label{data-listing-pscad-0p0001}
The following is the data generated by PSCAD for plotting against the hand-implemented solution.
\lstinputlisting[]{pscad-dat-0p0001.csv}

\subsection{PSCAD CSV File ($\Delta{}t = 0.0003s$)}
\label{data-listing-pscad-0p0003}
The following is the data generated by PSCAD for plotting against the hand-implemented solution.
\lstinputlisting[]{pscad-dat-0p0003.csv}

\subsection{MATLAB Listing}
\label{code-listing-matlab}
The following is the MATLAB listing that formed the matrices and generated the next voltage equations used in the Python script. 
\lstinputlisting[language=matlab]{equations.m}

\subsection{Fortran Code Listing}
\label{code-listing-fortran}
The following is the code generated by PSCAD to simulate the circuit for this assignment.
\lstinputlisting[language=Fortran]{pscad.f}

\end{document}

